<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>Firmware - Home Assistant LoRa sensor</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Firmware";
        var mkdocs_page_input_path = "firmware.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="." class="icon icon-home"> Home Assistant LoRa sensor
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="hardware.html">Hardware</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="lora.html">LoRa</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="firmware.html">Firmware</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#i2c">I2C</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#publish-interval">Publish interval</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#authentication-credentials">Authentication credentials</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#lora">LoRa</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#code-structure">Code structure</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#protobuf">protobuf</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#entity-class">Entity class</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#battery">Battery</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#lora-class">Lora class</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#sensor-class">Sensor class</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="nodered.html">Node-RED</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href=".">Home Assistant LoRa sensor</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="." class="icon icon-home" alt="Docs"></a> &raquo;</li><li>Firmware</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="firmware">Firmware</h1>
<p>The firmware is developed as a <a href="https://platformio.org/">platformio</a> project. It uses the espressif32 platform and arduino framework. </p>
<h2 id="configuration">Configuration</h2>
<p>Configuration is done through compiler flags to limit the need to modify the firmware.</p>
<h3 id="i2c">I2C</h3>
<p>Define the <code>SDA</code> and <code>SCL</code> pins as:</p>
<pre><code>build_flags = 

    -D PIN_SDA=21
    -D PIN_SCL=22
</code></pre>
<h3 id="publish-interval">Publish interval</h3>
<p>The publishing interval is defined as:</p>
<pre><code>build_flags = 

    -D PUBLISH_INTERVAL_SECS=10
    -D MODE_DEEP_SLEEP_MINS=0
</code></pre>
<p>Deep sleep has been investigated as a mechanism for extending battery life. At this revision, it doesn't work pending resolving an issue around waking up and reconnecting the LoRa radio. For now, set it to 0 minutes to disable the feature in firmware.</p>
<h3 id="authentication-credentials">Authentication credentials</h3>
<p>LoRa uses a The Things Netwotk (TTN) application (see <a href="lora.html">LoRa</a> for details). The firmware requires the app eui, dev ei, and app key to connect. To avoid exposing these authentication credentials in version control, they are obtained from a local file and provided as compiler flags.</p>
<p>To configure, create a file named <code>secret_auth_XXX.py</code> in the same directory as <code>platformio.ini</code>.  add them to this file in the following format:</p>
<pre><code># TTN 'heltec lora environment sensor' credentials

keys = {
  &quot;APP_EUI&quot;: &quot;XXX&quot;,
  &quot;DEV_EUI&quot;: &quot;XXX&quot;,
  &quot;APP_KEY&quot;: &quot;XXX&quot;,
}

print(f&quot;-D APP_EUI={keys['APP_EUI']} -D DEV_EUI={keys['DEV_EUI']} -D APP_KEY={keys['APP_KEY']} &quot;)
</code></pre>
<p>Finally, add the following buid flag specifier in <code>platformio.ini</code>:</p>
<pre><code>build_flags = 

    !python secret_auth_XXX.py

</code></pre>
<h3 id="lora">LoRa</h3>
<p>The firmware uses Francois Riotte's library <a href="https://github.com/rgot-org/TheThingsNetwork_esp32">TheThingsNetwork_esp32</a>. This requires a number of compiler definitions for specifying e.g. the LoRaWAN specification, region, etc. as described <a href="https://github.com/mcci-catena/arduino-lmic#configuration">here</a>.</p>
<p>Check <code>platformio.ini</code> for actual variables, but these typically are:</p>
<pre><code>[env:ttgo-lora32-v21]

build_flags = 

    -D ARDUINO_LMIC_PROJECT_CONFIG_H_SUPPRESS
    -D CFG_eu868=1
    -D CFG_sx1276_radio=1
    -D LMIC_LORAWAN_SPEC_VERSION=LMIC_LORAWAN_SPEC_VERSION_1_0_3
</code></pre>
<p>Additional flags are required to specify the pins used for LoRa boards which are not pre-integrated (which the TTGO LoRa v21 is not). These are specified as follows:</p>
<pre><code>build_flags = 

    -D NSS=18
    -D RST=14
    -D DIO0=26
    -D DIO1=33
    -D DIO2=32
</code></pre>
<p><a href="https://www.dropbox.com/s/gly6z21qqps7uvc/espMeshtasticBoards_ev01.xls?dl=0">This spreadsheet</a> may help you identify the pins for your microcontroller.</p>
<h2 id="code-structure">Code structure</h2>
<p>The code employs a simple plugin architecture to allow new devices to be added relatively easily. It defines a <code>Sensor</code> object representing the <code>Lora</code> driver object, and one or more <code>Entity</code> objects providing <code>attributes</code> (using the <a href="https://www.home-assistant.io/docs/configuration/customizing-devices">language of Home Assistant</a>). At setup, the lora and entities are registered and started. The runloop drives a timer for the publishing interval.</p>
<p>If this isn't clear: an 'entity' is something like an SHT31 temperature and humidity sensor. 'Temperature' and 'humidity' are attributes of that sensor.</p>
<h3 id="protobuf">protobuf</h3>
<p>The device employes Google's <a href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a> for serialising and transmitting data. This has the advantage of generating very efficient packets, which reduces power requirements and extends battery life. It has the disadvantage of being a pain to implement on microcontrollers. I've made it as simple as possible to extend. </p>
<p>The schema is defined in <code>/protobuf-packet/packet.proto</code>. String sizes for any metadata must be defined in <code>/protobuf-packet/packet.options</code>. Together, these define a <code>Packet</code> data structure that can be processed be e.g. <a href="nodered.html">node-RED</a>. If you alter this, you need to regenerate the header and implementation code in <code>proto</code> (don't alter these by hand) - see <code>/protobuf-packet/README.md</code> for instructions.</p>
<p>The result of this is a set of constants you can use in your entity implementations to define entity and attribute properties -- look at an existing Entity implementationfor how to do it.</p>
<h3 id="entity-class">Entity class</h3>
<p>This handles starting the entity, reading the data, and serialising it. Each entity object provides a <code>start()</code> method and a <code>readData()</code> method. <code>start()</code> returns <code>true</code> if startup and initialising was successful. <code>readData()</code> obtains the latest data from the sensor and serialises it for encoding by the LoRa class.</p>
<h4 id="battery">Battery</h4>
<p>An entity class (<code>EntityBattery</code>) is defined for reporting the device battery voltage. This may require calibration on your battery as follows:</p>
<pre><code>build_flags = 

    -D BATTERY_CORRECTION_FACTOR=0.885
</code></pre>
<p>I set it to one, measured the voltage and compared it to the reported value, then computed the correction factor.</p>
<h3 id="lora-class">Lora class</h3>
<p>This handles starting the radio, joining The Things Network, serialising the readings from the sensors, and transmitting it. The device will hang during <code>start()</code> if it cannot join. <code>publish()</code> takes a vector of readings from the sensors, encodes it as a protocol buffer <code>Packet</code>, and transmits it.</p>
<h3 id="sensor-class">Sensor class</h3>
<p>This handles registering entities and the radio, starting them, reading their data at a defined interval, and sending the data to the LoRa for transmission.</p>
<p>Add new entities like so:</p>
<pre><code>#include &lt;EntityMyExcellentThing.h&gt;
EntityMyExcellentThing  excellentThing;
void setup()
{
    ...
    sensor.registerEntity( &amp;excellentThing );
}
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="lora.html" class="btn btn-neutral float-left" title="LoRa"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="nodered.html" class="btn btn-neutral float-right" title="Node-RED">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="lora.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="nodered.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme_extra.js" defer></script>
    <script src="js/theme.js" defer></script>
      <script src="search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
